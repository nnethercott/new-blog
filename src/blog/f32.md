{
	"published": "2025-08-17",
  "description": ""
}

# Exploiting a 40 year-old design choice to speed up vector search

A while ago, I came across a post on reddit about a user's experience [speeding up the rav1d video decoder](https://ohadravid.github.io/posts/2025-05-rav1d-faster/) and got inspired by a simple trick they used to eke out a ~1% improvement.

The hack involved replacing field-wise equality with byte-wise equality for a struct, which translated in code as a custom impl of `PartialEq`. Doing this greatly reduced the number of instructions in the resulting assembly code by almost half and translated to tangible speedups in the decoder.

So instead of this :
```rust
use zerocopy::{AsBytes}

#[derive(PartialEq, AsBytes)]
#[repr(C)]
pub struct Foo{
  a: i32,
  b: i32
}
```

You'd instead write :

```rust
use zerocopy::{AsBytes}

#[derive(AsBytes)]
#[repr(C)]
pub struct Foo{
  a: i32,
  b: i32
}

impl PartialEq for Foo{
  fn eq(&self, other: &Self) -> bool {
    // NOTE: `as_bytes` comes from #[derive(AsBytes)]
    self.as_bytes()  == other.as_bytes()
  }
}
```


This article got me thinking about applying the same trick to [a vector database I'd been writing](https://github.com/nnethercott/hannoy), in which a significant amount of time is spent ordering `f32`'s to determine if an item is a nearest neighbour or not. I figured it was the perfect setting to try it out, except rather than implementing `PartialEq` I'd be implementing `Ord`.


## Rust, `f32`, `Ord`, and sadness {#background}
In rust, `f32` doesn't implement `Ord` or `Eq`. Consulting the docs on [NaN's](https://doc.rust-lang.org/std/primitive.f32.html#nan-bit-patterns) explains why :

> - It is not equal to any float, including itself! This is the reason f32 doesn’t implement the Eq trait.
> - It is also neither smaller nor greater than any float, making it impossible to sort by the default comparison operation, which is the reason f32 doesn’t implement the Ord trait. [[link]](https://doc.rust-lang.org/std/primitive.f32.html)

This is why you need a crate like [ordered-float](https://docs.rs/ordered-float/latest/ordered_float/) if you want to work with any container that enforces a trait bound on `Ord` like 

## some benchmarks {#benches}
