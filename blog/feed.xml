<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><title>nostromo</title><id>https://nnethercott.github.io/blog/</id><updated>2025-08-17T00:00:00+00:00</updated><author><name>nostromo</name><uri>https://nnethercott.github.io/</uri></author><generator uri="https://github.com/nnethercott/nnethercott.github.io">nnethercott.github.io</generator><icon>https://nnethercott.github.io//apple-touch-icon.png</icon><link href="https://nnethercott.github.io/blog/feed.xml" rel="self" type="application/atom+xml"/><link href="https://nnethercott.github.io/blog/" rel="alternate" type="text/html"/><entry><title>Exploiting a 40 year-old design choice to speed up vector search</title><id>https://nnethercott.github.io/blog/f32</id><updated>2025-08-17T00:00:00+00:00</updated><link href="https://nnethercott.github.io/blog/f32" rel="alternate" type="text/html" title="Exploiting a 40 year-old design choice to speed up vector search"/><published>2025-08-17T00:00:00+00:00</published><summary></summary><content xml:base="https://nnethercott.github.io/blog/f32" type="html">&lt;p&gt;A while ago, I came across a post on reddit about a user’s experience &lt;a href=&apos;https://ohadravid.github.io/posts/2025-05-rav1d-faster/&apos;&gt;speeding up the rav1d video decoder by 1%&lt;/a&gt;, which inspired me to try a similar trick to speed up sorting &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s in &lt;a href=&apos;https://github.com/nnethercott/hannoy&apos;&gt;my vector database&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;The hack from the post involved swapping &lt;em&gt;field-wise&lt;/em&gt; equality for &lt;em&gt;byte-wise&lt;/em&gt; equality, which translated into a custom impl of &lt;code class=&apos;scode&apos;&gt;PartialEq&lt;/code&gt; for the struct in question. Doing this greatly reduced the number of instructions in the resulting assembly code by almost half and yielded tangible speedups in the decoder.&lt;/p&gt;&lt;p&gt;So instead of this :&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource srust&quot;&gt;&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;zerocopy&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;AsBytes&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;PartialEq&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; AsBytes&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;repr&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;C&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;sstorage stype sstruct srust&quot;&gt;struct&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;sentity sname sstruct srust&quot;&gt;Foo&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;svariable sother smember srust&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;i32&lt;/span&gt;,
  &lt;span class=&quot;svariable sother smember srust&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;i32&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You’d write :&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource srust&quot;&gt;&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;zerocopy&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;AsBytes&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;AsBytes&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;repr&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;C&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;sstorage stype sstruct srust&quot;&gt;struct&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;sentity sname sstruct srust&quot;&gt;Foo&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;svariable sother smember srust&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;i32&lt;/span&gt;,
  &lt;span class=&quot;svariable sother smember srust&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;i32&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;sstorage stype simpl srust&quot;&gt;impl&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;PartialEq &lt;span class=&quot;skeyword sother srust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt; &lt;span class=&quot;sentity sname simpl srust&quot;&gt;Foo&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;eq&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;span class=&quot;smeta sfunction sreturn-type srust&quot;&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt; NOTE: `as_bytes` comes from #[derive(AsBytes)]
&lt;/span&gt;    &lt;span class=&quot;svariable slanguage srust&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;as_bytes&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;  &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; other.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;as_bytes&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now when we consider the equality of two &lt;code class=&apos;scode&apos;&gt;&amp;amp;Foo&lt;/code&gt;’s we just look at &lt;code class=&apos;scode&apos;&gt;&amp;amp;[u8]&lt;/code&gt; slices instead of doing a field-by-field check.&lt;/p&gt;&lt;p&gt;In vector search applications, a non-negligeable amount of time is spent ordering &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s to determine if an item is a nearest neighbour or not. I figured it was the perfect setting to try out the approach above.&lt;/p&gt;&lt;h2 id=&apos;background&apos;&gt;&lt;a href=&apos;#background&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Rust, &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;, &lt;code class=&apos;scode&apos;&gt;Ord&lt;/code&gt;, and sadness&lt;/h2&gt;&lt;p&gt;In rust, &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt; doesn’t implement &lt;code class=&apos;scode&apos;&gt;Ord&lt;/code&gt; or &lt;code class=&apos;scode&apos;&gt;Eq&lt;/code&gt;. Consulting the docs on &lt;a href=&apos;https://doc.rust-lang.org/std/primitive.f32.html#nan-bit-patterns&apos;&gt;NaN’s&lt;/a&gt; explains why :&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;It is not equal to any float, including itself! This is the reason f32 doesn’t implement the Eq trait.&lt;/li&gt;&lt;li&gt;It is also neither smaller nor greater than any float, making it impossible to sort by the default comparison operation, which is the reason f32 doesn’t implement the Ord trait. &lt;a href=&apos;https://doc.rust-lang.org/std/primitive.f32.html&apos;&gt;[link]&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;&lt;p&gt;This is why you need a crate like &lt;a href=&apos;https://docs.rs/ordered-float/latest/ordered_float/&apos;&gt;ordered-float&lt;/a&gt; if you wish to work with containers like &lt;code class=&apos;scode&apos;&gt;std::collections::BinaryHeap&amp;lt;T&amp;gt;&lt;/code&gt; that enforces the &lt;code class=&apos;scode&apos;&gt;T: Ord&lt;/code&gt; trait bound to perform sorting internally.&lt;/p&gt;&lt;p&gt;&lt;code class=&apos;scode&apos;&gt;ordered-float&lt;/code&gt; is great most of the time, but in the context of vector search I think it’s a bit overkill.&lt;/p&gt;&lt;p&gt;For starters, we’re only working with &lt;em&gt;non-negative&lt;/em&gt;  &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s coming from &lt;a href=&apos;https://en.wikipedia.org/wiki/Metric_space#Definition&apos;&gt;distance metrics&lt;/a&gt;, not the whole representable range. For another, the &lt;code class=&apos;scode&apos;&gt;ordered-float&lt;/code&gt; crate also implements &lt;code class=&apos;scode&apos;&gt;Hash&lt;/code&gt; for it’s &lt;code class=&apos;scode&apos;&gt;OrderedFloat&amp;lt;f32&amp;gt;&lt;/code&gt; wrapper type which adds some lines of code to the final executable that we don’t really need.&lt;/p&gt;&lt;p&gt;On top of this, the project itself is around ~3k SLOC, while a &lt;a href=&apos;https://github.com/nnethercott/hannoy/blob/main/src/ordered_float.rs&apos;&gt;bare-bones implementation doing only what we need&lt;/a&gt; takes less than 50 SLOC.&lt;/p&gt;&lt;h2 id=&apos;ieee&apos;&gt;&lt;a href=&apos;#ieee&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Getting sneaky with IEEE 754&lt;/h2&gt;&lt;p&gt;Floats are generally made up of 3 components: a sign bit; some exponent bits; and some mantissa (fraction) bits. This format goes all the way back to the &lt;a href=&apos;https://en.wikipedia.org/wiki/IEEE_754&apos;&gt;IEEE 754 Standard&lt;/a&gt; from 1985, and is what’s going to help us here today.&lt;/p&gt;&lt;p&gt;By playing around with the number of bits you allocate between the exponent and mantissa you can cover a wider &lt;a href=&apos;https://en.wikipedia.org/wiki/Dynamic_range&apos;&gt;dynamic range&lt;/a&gt; or achieve higher precision depending on your use-case. &lt;code class=&apos;scode&apos;&gt;bf16&lt;/code&gt; for instance allocates fewer fraction bits while maintaining the same number of exponent bits as &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;, making it less precise but covering the same dynamic range.&lt;/p&gt;&lt;figure&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/f32_post/f32_754.png&quot; style=&quot;padding: 1em; width: 100%; display: block; margin: 0 auto;&quot; &gt;
    &lt;figcaption&gt;
      Bit-layout of an f32 &lt;a href = &quot;https://en.wikipedia.org/wiki/Single-precision_floating-point_format&quot;&gt;[1]&lt;/a&gt;
    &lt;/figcaption&gt;
&lt;/div&gt;
&lt;/figure&gt;
&lt;p&gt;To convert from a 32-bit integer back to an &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt; you use the following formula: $$ x = (-1)^{\text{sign}}\times2^{(\text{exponent}-127)}\times\left(1+\sum_{i=1}^{23}b^{(fraction)}_{i}2^{-i} \right) $$&lt;/p&gt;&lt;p&gt;While it may be true that $-x\leq x$ in &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;-world, the same relationship doesn’t hold when we interpret those same &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s as &lt;code class=&apos;scode&apos;&gt;u32&lt;/code&gt;’s. It’s enough to look at the sign bit and see why; any negative number has the most significant bit set to 1 which automatically makes it larger as an integer than its positive counterpart.&lt;/p&gt;&lt;p&gt;This is why statements like &lt;code class=&apos;scode&apos;&gt;(f32::MAX).to_bits()&lt;/code&gt; &amp;lt; &lt;code class=&apos;scode&apos;&gt;(-0.0f32).to_bits()&lt;/code&gt; evaluate to &lt;code class=&apos;scode&apos;&gt;true&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Ok, so we can’t just compare &lt;code class=&apos;scode&apos;&gt;&amp;amp;[u8]&lt;/code&gt;’s and call it a day… &lt;em&gt;or can we ?&lt;/em&gt;&lt;/p&gt;&lt;p&gt;Recall that all the &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s we need to sort come from distance calculations (e.g. cosine, euclidean, hamming, etc.) so we can guarantee that they’re always $\geq 0$ ! &lt;strong&gt;This means it’s totally valid to compare the &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s as if they were integers&lt;/strong&gt;.&lt;/p&gt;&lt;p&gt;The only edge case we really need to look out for is a &lt;code class=&apos;scode&apos;&gt;-0.0f32&lt;/code&gt; showing up from float arithmetic, but we can add an assert to filter cases like these out.&lt;/p&gt;&lt;h2 id=&apos;custom-ordered-float&apos;&gt;&lt;a href=&apos;#custom-ordered-float&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Ordering your own floats&lt;/h2&gt;&lt;p&gt;I’ll be honest, the code I’m about to share is pretty underwhelming, it’s exactly what you’d expect if you’ve been reading along so far. But hey, it works !&lt;/p&gt;&lt;p&gt;Here it is :&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource srust&quot;&gt;&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;Default&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; Debug&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; Clone&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; Copy&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;sstorage stype sstruct srust&quot;&gt;struct&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;sentity sname sstruct srust&quot;&gt;OrderedFloat&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstruct srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;pub &lt;span class=&quot;sstorage stype srust&quot;&gt;f32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;sstorage stype simpl srust&quot;&gt;impl&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;PartialEq &lt;span class=&quot;skeyword sother srust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt; &lt;span class=&quot;sentity sname simpl srust&quot;&gt;OrderedFloat&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;eq&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;span class=&quot;smeta sfunction sreturn-type srust&quot;&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;svariable slanguage srust&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sfloat srust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;ssupport sfunction srust&quot;&gt;to_bits&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;other.&lt;span class=&quot;sconstant snumeric sfloat srust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;ssupport sfunction srust&quot;&gt;to_bits&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
    &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;sstorage stype simpl srust&quot;&gt;impl&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;Eq &lt;span class=&quot;skeyword sother srust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt; &lt;span class=&quot;sentity sname simpl srust&quot;&gt;OrderedFloat&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;sstorage stype simpl srust&quot;&gt;impl&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;PartialOrd &lt;span class=&quot;skeyword sother srust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt; &lt;span class=&quot;sentity sname simpl srust&quot;&gt;OrderedFloat&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;partial_cmp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;span class=&quot;smeta sfunction sreturn-type srust&quot;&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Option&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;std&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;cmp&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Ordering&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;ssupport stype srust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;svariable slanguage srust&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;other&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
    &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;sstorage stype simpl srust&quot;&gt;impl&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;Ord &lt;span class=&quot;skeyword sother srust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt; &lt;span class=&quot;sentity sname simpl srust&quot;&gt;OrderedFloat&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta simpl srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;cmp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;span class=&quot;smeta sfunction sreturn-type srust&quot;&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;std&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;cmp&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Ordering&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;svariable slanguage srust&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sfloat srust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;ssupport sfunction srust&quot;&gt;to_bits&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;other.&lt;span class=&quot;sconstant snumeric sfloat srust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;ssupport sfunction srust&quot;&gt;to_bits&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
    &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This struct does everything we need; no more, no less !&lt;/p&gt;&lt;p&gt;Note that we &lt;em&gt;should&lt;/em&gt; add some kind of check in the constructor to ensure our &lt;code class=&apos;scode&apos;&gt;OrderedFloat&lt;/code&gt; isn’t being built with a negative number, but for the sake of this blog post I’ll skip that.&lt;/p&gt;&lt;h2 id=&apos;benches&apos;&gt;&lt;a href=&apos;#benches&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Benchmark&lt;/h2&gt;&lt;p&gt;Recall that way back at the start of this post I stated the goal was to see if comparing &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s &lt;em&gt;byte-wise&lt;/em&gt; was faster doing “proper”&lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt; comparisons. Well let’s do that.&lt;/p&gt;&lt;p&gt;We’ll benchmark how long it takes to build a &lt;code class=&apos;scode&apos;&gt;BinaryHeap&lt;/code&gt; from both my &lt;code class=&apos;scode&apos;&gt;OrderedFloat&lt;/code&gt; and the &lt;code class=&apos;scode&apos;&gt;ordered_float::OrderedFloat::&amp;lt;f32&amp;gt;&lt;/code&gt;.&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;As an aside, I recently switched from &lt;a href=&apos;https://github.com/bheisler/criterion.rs&apos;&gt;criterion&lt;/a&gt; to &lt;a href=&apos;https://github.com/nvzqz/divan&apos;&gt;divan&lt;/a&gt; for benchmarking due to it’s simple and expressive syntax, and I’ve gotta say I’ve been loving it ! 🎉&lt;/p&gt;&lt;/blockquote&gt;&lt;details&gt;
&lt;summary&gt;Click here to expand the benchmarking code&lt;/summary&gt;
&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource srust&quot;&gt;&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;std&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;collections&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;BinaryHeap&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;divan&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;svariable slanguage srust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; Bencher&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;counter&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;BytesCount&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;f32_blogpost_bench&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;OrderedFloat&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;rand&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rng&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;main&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;smeta spath srust&quot;&gt;divan&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;main&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;divan&lt;/span&gt;::&lt;span class=&quot;svariable sannotation srust&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;consts &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; [10&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; 100&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; 1000&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; 10000]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;custom_ord_impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgeneric srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;const N&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;bencher&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; Bencher&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    bencher
        .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;with_inputs&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; nums &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;default&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;;&lt;/span&gt; N&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;smeta spath srust&quot;&gt;rand&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;rng&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; nums&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; nums_cmp&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Result&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage smodifier slifetime srust&quot;&gt;&amp;#39;static&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;
                nums.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;into_iter&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;OrderedFloat&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;try_from&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

            nums_cmp.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
        .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;bench_values&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;vec&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;BinaryHeap&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;vec&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sannotation srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sannotation srust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;svariable sannotation srust&quot;&gt;divan&lt;/span&gt;::&lt;span class=&quot;svariable sannotation srust&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;consts &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; [10&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; 100&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; 1000&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; 10000]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sannotation sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;ordered_float_crate&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgeneric srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;const N&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;bencher&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; Bencher&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    bencher
        .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;with_inputs&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; nums &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;default&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;;&lt;/span&gt; N&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;smeta spath srust&quot;&gt;rand&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;rng&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; nums&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; nums_cmp&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; nums
                .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;into_iter&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
                .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;ordered_float&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;OrderedFloat&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgeneric srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
                .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

            nums_cmp
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
        .&lt;span class=&quot;ssupport sfunction srust&quot;&gt;bench_values&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;vec&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;BinaryHeap&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;vec&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;
&lt;figure&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/f32_post/divan.png&quot; style=&quot;padding: 1em; width: 100%; display: block; margin: 0 auto;&quot; &gt;
&lt;/div&gt;
&lt;/figure&gt;
&lt;p&gt;As you can see, by comparing &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;s via their &lt;code class=&apos;scode&apos;&gt;&amp;amp;[u8]&lt;/code&gt; representation we’re able to fill a &lt;code class=&apos;scode&apos;&gt;BinaryHeap&lt;/code&gt; twice as quickly on average!&lt;/p&gt;&lt;h2 id=&apos;conclusion&apos;&gt;&lt;a href=&apos;#conclusion&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;&lt;p&gt;I’ll be the first to admit that these speedups are relatively small when you consider that &lt;a href=&apos;https://qdrant.tech/benchmarks/&apos;&gt;a typical search usually takes O(10ms)&lt;/a&gt;, but I find it intellectually satisfying that we were able to leverage the structure of our data to squeeze out some speed gains.&lt;/p&gt;&lt;p&gt;To summarize everything, in this article we exploited both the fact that &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s coming from distance calculations are never negative, as well the 32-bit layout of a single-precision float, in order to compare &lt;code class=&apos;scode&apos;&gt;f32&lt;/code&gt;’s more efficiently.&lt;/p&gt;&lt;figure&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/f32_post/flame.png&quot; style=&quot;padding: 1em; width: 100%; display: block; margin: 0 auto;&quot; &gt;
    &lt;figcaption&gt;
      Vector search in hannoy is currently dominated by SIMD and LMDB lookups.
    &lt;/figcaption&gt;
&lt;/div&gt;
&lt;/figure&gt;
&lt;p&gt;There’s still &lt;em&gt;much&lt;/em&gt; work to be done to speed up the vector db further, but we take speedups where we can get them :)&lt;/p&gt;</content></entry><entry><title>My tokenizer is faster than yours (probably)</title><id>https://nnethercott.github.io/blog/tok</id><updated>2024-05-10T00:00:00+00:00</updated><link href="https://nnethercott.github.io/blog/tok" rel="alternate" type="text/html" title="My tokenizer is faster than yours (probably)"/><published>2024-05-10T00:00:00+00:00</published><summary></summary><content xml:base="https://nnethercott.github.io/blog/tok" type="html">&lt;!-- &quot;description&quot;: &quot;An O(m*log n) optimization I found to speed up tokenizer throughput&quot; --&gt;
&lt;p&gt;In this article I’ll run through how I used Rust and pyo3 to implement a fast BPE tokenizer (4x faster than &lt;a href=&apos;https://github.com/huggingface/tokenizers&apos;&gt;tokenizers&lt;/a&gt; and as fast as &lt;a href=&apos;https://github.com/openai/tiktoken&apos;&gt;tiktoken&lt;/a&gt;) which you can install from PyPI today!&lt;/p&gt;&lt;p&gt;All the code mentioned in this post can be found &lt;a href=&apos;https://github.com/nnethercott/tok&apos;&gt;on github&lt;/a&gt;.&lt;/p&gt;&lt;figure&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/tok_post/performance.png&quot; style=&quot;width: 80%; display: block; margin: 0 auto;&quot; &gt;
    &lt;figcaption&gt;
      Speed comparison between my tokenizer (yellow) and popular libraries like Hugging Face and OpenAI
    &lt;/figcaption&gt;
&lt;/div&gt;
&lt;/figure&gt;
&lt;p&gt;This article is about an efficient way I discovered to quickly encode and decode sequences using a pretrained tokenizer rather than an in-depth review of byte-pair encoding. For that feel free to check out any of these links: &lt;a href=&apos;https://en.wikipedia.org/wiki/Byte_pair_encoding&apos;&gt;wikipedia&lt;/a&gt;, &lt;a href=&apos;https://huggingface.co/learn/nlp-course/en/chapter6/5&apos;&gt;huggingface&lt;/a&gt;, &lt;a href=&apos;https://github.com/openai/tiktoken&apos;&gt;tiktoken&lt;/a&gt;.&lt;/p&gt;&lt;h2 id=&apos;naive&apos;&gt;&lt;a href=&apos;#naive&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;An &lt;em&gt;O(mn)&lt;/em&gt; first attempt&lt;/h2&gt;&lt;p&gt;Suppose you’ve already trained a tokenizer (doing this is trivial), i.e. you have a some hashmap-like object that lets you map a sequence of bytes to unique tokens. What’s the fastest way to use this lookup table to encode and decode your data?&lt;/p&gt;&lt;!-- ### A basic approach --&gt;
&lt;p&gt;The easiest approach is to loop over all the possible token merges in the order we learned them and replace any matches we find along the way. For example, if your tokenizer has the following token mapping rules:&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;{(97, 97): 128, (128,97): 129, (129, 98): 130}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then the encoding for “aaabcaaab” (or [97,97,97,98,99,97,97,97,98] as a byte array) would look like this (notice how everything gets &lt;em&gt;compressed&lt;/em&gt;):&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;1. [97,97,97,98,99,97,97,97,98] -&amp;gt; [128,97,98,99,128,97,98]
2. [128,97,98,99,128,97,98] -&amp;gt; [129,98,99,129,98]
3. [129,98,99,129,98] -&amp;gt; [130,99,130]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In Rust you can write that loop as:&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource srust&quot;&gt;&lt;span class=&quot;skeyword sother srust&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;std&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;collections&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;HashMap&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;sstorage stype stype srust&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;sentity sname stype srust&quot;&gt;Rank&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;_byte_pair_merge&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;pieces&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;pair&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;Rank&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter srust&quot;&gt;Rank&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; Rank&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;skeyword scontrol srust&quot;&gt;while&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;lt;&lt;/span&gt; pieces.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; pair &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; replace&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            pieces.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        i &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
    &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;encode&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;str&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;smeta sgeneric srust&quot;&gt;HashMap&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;Rank, Rank&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;, Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;span class=&quot;smeta sfunction sreturn-type srust&quot;&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; pieces&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; text.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;as_bytes&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;x &lt;span class=&quot;skeyword soperator srust&quot;&gt;as&lt;/span&gt; Rank&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt;reverse (k,v) to (v,k)
&lt;/span&gt;    &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; reverse_map&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;HashMap&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;Rank, &lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;Rank, Rank&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; map.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&amp;amp;&lt;span class=&quot;svariable sparameter srust&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; &amp;amp;&lt;span class=&quot;svariable sparameter srust&quot;&gt;r&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; p&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt;O(m*n)
&lt;/span&gt;    &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt;assume first token has index 128 since we&amp;#39;re encoding for ascii
&lt;/span&gt;    &lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;reverse_map.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;rev&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;for_each&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;pair &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; reverse_map.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;skeyword soperator srust&quot;&gt;as&lt;/span&gt; Rank&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;ssupport sfunction srust&quot;&gt;_byte_pair_merge&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; pieces&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; pair&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;as&lt;/span&gt; Rank&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
    &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

    pieces
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;For a vocabulary size of 50257, the token throughput with this approach for a 2.5MB subset of the &lt;a href=&apos;https://huggingface.co/datasets/wikitext&apos;&gt;wikitext dataset&lt;/a&gt; is somewhere in the neighborhood of &lt;strong&gt;0.09MB/s&lt;/strong&gt;.&lt;/p&gt;&lt;p&gt;This approach definitely gets the job done but it’s incredibly inefficient! Indeed, this solution has a time complexity of $O(mn)$, where $m$ is the vocab size and $n$ is the length of the text you want to encode. As the vocabulary size and/or length of the text increase we get significant slowdowns.&lt;/p&gt;&lt;h2 id=&apos;efficient&apos;&gt;&lt;a href=&apos;#efficient&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Leetcode maxxing: An &lt;em&gt;O(m log(n))&lt;/em&gt; solution !&lt;/h2&gt;&lt;p&gt;The approach I ended up stumbling across after around 6 hours of refactoring is closer to $O(m\log{n})$. It relies on the fact that we don’t need to loop over every entry in the hashmap when it’s sufficient to notice that we can apply merges in a way which respects the order the tokenizer learned them in. This lets us apply multiple different token merges in a single pass instead of only searching for a single pattern each time. We can also detect early on if no more token merging is possible and break out of the function.&lt;/p&gt;&lt;p&gt;If you’ve been grinding your fair share of Leetcode this sort of &lt;a href=&apos;https://www.geeksforgeeks.org/dsa/two-pointers-technique/&apos;&gt;two-pointers approach&lt;/a&gt; should feel familiar…&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource srust&quot;&gt;&lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt;lib.rs
&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;sstorage stype sfunction srust&quot;&gt;fn&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;sentity sname sfunction srust&quot;&gt;encode&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage stype srust&quot;&gt;str&lt;/span&gt;, &lt;span class=&quot;svariable sparameter srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Map&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;Rank, Rank&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;, Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt; &lt;span class=&quot;smeta sfunction sreturn-type srust&quot;&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction srust&quot;&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; pieces&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;smeta sgeneric srust&quot;&gt;Vec&lt;span class=&quot;spunctuation sdefinition sgeneric sbegin srust&quot;&gt;&amp;lt;&lt;/span&gt;Rank&lt;span class=&quot;spunctuation sdefinition sgeneric send srust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; text.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;as_bytes&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;&lt;span class=&quot;smeta sfunction sparameters srust&quot;&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;svariable sparameter srust&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send srust&quot;&gt;|&lt;/span&gt;&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;smeta sfunction sclosure srust&quot;&gt;x &lt;span class=&quot;skeyword soperator srust&quot;&gt;as&lt;/span&gt; Rank&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;skeyword scontrol srust&quot;&gt;loop&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; merges &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ssupport stype srust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;smeta spath srust&quot;&gt;&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;skeyword scontrol srust&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;..&lt;/span&gt;pieces.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;ssupport stype srust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;rank&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; map.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
                merges.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;spunctuation sseparator srust&quot;&gt;,&lt;/span&gt; rank&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt;early stopping
&lt;/span&gt;        &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; merges.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;is_empty&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;skeyword scontrol srust&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;

        &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt; apply merges and swap in tokens from reverse
&lt;/span&gt;        &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; merges.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;skeyword scontrol srust&quot;&gt;while&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; x &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;sstorage smodifier srust&quot;&gt;mut&lt;/span&gt; merges&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;i&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; l &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;sstorage stype srust&quot;&gt;let&lt;/span&gt; r &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

            &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt; l.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;amp;&lt;/span&gt; r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;Rank&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;sconstant sother srust&quot;&gt;MAX&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
                pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
                pieces.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword scontrol srust&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;lt;&lt;/span&gt; l.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
                pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
                pieces.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;r.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;

                x&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta spath srust&quot;&gt;Rank&lt;span class=&quot;spunctuation saccessor srust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;sconstant sother srust&quot;&gt;MAX&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
                i &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;scomment sline sdouble-slash srust&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment srust&quot;&gt;//&lt;/span&gt;avoid overflow on usize 0-1
&lt;/span&gt;            &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; i &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;skeyword scontrol srust&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
            i &lt;span class=&quot;skeyword soperator srust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;skeyword scontrol srust&quot;&gt;if&lt;/span&gt; merges.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;skeyword soperator srust&quot;&gt;|&lt;/span&gt; merges&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;&amp;lt;&lt;/span&gt; merges&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock sbegin srust&quot;&gt;{&lt;/span&gt;
            pieces&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;merges&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;=&lt;/span&gt; merges&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
            pieces.&lt;span class=&quot;ssupport sfunction srust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;(&lt;/span&gt;merges&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin srust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;.&lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;skeyword soperator srust&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal srust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sgroup srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup send srust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sterminator srust&quot;&gt;;&lt;/span&gt;
        &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
    &lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
    pieces
&lt;/span&gt;&lt;span class=&quot;smeta sblock srust&quot;&gt;&lt;span class=&quot;spunctuation ssection sblock send srust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;On the same wikitext split our throughput using this encoding algorithm jumps to &lt;strong&gt;24.35MB/s&lt;/strong&gt;. That’s over a 100x improvement with respect to where we started from.&lt;/p&gt;&lt;p&gt;I took a lot of inspiration from official &lt;a href=&apos;https://github.com/openai/tiktoken/blob/main/src/lib.rs&apos;&gt;openai implementation&lt;/a&gt; in their repo &lt;code class=&apos;scode&apos;&gt;tiktoken&lt;/code&gt; but handled the merging aspect quite differently by leveraging the fact that we could store the prospective merges in a stack instead of finding the single-best merge at each iteration.&lt;/p&gt;&lt;h2 id=&apos;python-bindings&apos;&gt;&lt;a href=&apos;#python-bindings&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Python bindings with pyo3&lt;/h2&gt;&lt;p&gt;To expose the Rust code in Python I made use of &lt;a href=&apos;https://github.com/PyO3/pyo3&apos;&gt;pyo3&lt;/a&gt; and &lt;a href=&apos;https://github.com/PyO3/maturin&apos;&gt;maturin&lt;/a&gt;. Getting started with these libraries is incredibly easy and just requires adding a few pyo3 attributes to your existing rust code. What’s also nice is that maturin automatically adds a CI workflow to your project which makes distributing your python package infinitely easier. By default the workflow listens for new tag pushes to the main branch and builds the wheels for all the major platforms.&lt;/p&gt;&lt;p&gt;I encourage you to check out &lt;a href=&apos;https://github.com/PyO3/setuptools-rust/tree/main/examples&apos;&gt;a few official examples&lt;/a&gt; and the &lt;a href=&apos;https://pyo3.rs/v0.21.2/&apos;&gt;pyo3 docs&lt;/a&gt;, overall though its a pretty frictionless experience.&lt;/p&gt;&lt;p&gt;Using maturin I published &lt;a href=&apos;https://pypi.org/project/toktokenizer/&apos;&gt;&lt;code class=&apos;scode&apos;&gt;toktokenizer&lt;/code&gt;&lt;/a&gt; - a lightweight python package for BPE tokenizers - to PyPI. The only class the library exposes is &lt;code class=&apos;scode&apos;&gt;BPETokenizer&lt;/code&gt;. The class itself is pretty minimal, with all major methods being showed below:&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource spython&quot;&gt;&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; demo.py
&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;skeyword scontrol simport sfrom spython&quot;&gt;from&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;smeta simport-source spython&quot;&gt; &lt;span class=&quot;smeta simport-path spython&quot;&gt;&lt;span class=&quot;smeta simport-name spython&quot;&gt;toktokenizer&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;skeyword scontrol simport spython&quot;&gt;import&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt; &lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;BPETokenizer&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;bpe&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;tok&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;BPETokenizer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; train a byte-pair tokenizer on some corpus
&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;train_corpus&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sstring sbegin spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;this is some training data&lt;span class=&quot;spunctuation sdefinition sstring send spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;vocab_size&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;bpe&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;train&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;train_corpus&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;vocab_size&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; save tokenizer state
&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;bpe&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;save_encoder&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sstring sbegin spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;8word.json&lt;span class=&quot;spunctuation sdefinition sstring send spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; load tokenizer from dumped file
&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;bpe&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;load_encoder&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sstring sbegin spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;8word.json&lt;span class=&quot;spunctuation sdefinition sstring send spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; encode and decode
&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;input_ids&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;bpe&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;encode&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sstring sbegin spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted sdouble spython&quot;&gt;some data&lt;span class=&quot;spunctuation sdefinition sstring send spython&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;decoded&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;bpe&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;decode&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;input_ids&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;To get started with &lt;code class=&apos;scode&apos;&gt;toktokenizer&lt;/code&gt; today you can install it with pip as follows:&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;pip install toktokenizer
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I’m looking forward to using this library moving forwards as I build up various components of modern NLP models from scratch!&lt;/p&gt;</content></entry><entry><title>Sparse Bayesian priors for training variational autoencoders</title><id>https://nnethercott.github.io/blog/vae</id><updated>2023-10-23T00:00:00+00:00</updated><link href="https://nnethercott.github.io/blog/vae" rel="alternate" type="text/html" title="Sparse Bayesian priors for training variational autoencoders"/><published>2023-10-23T00:00:00+00:00</published><summary></summary><content xml:base="https://nnethercott.github.io/blog/vae" type="html">&lt;!-- &quot;Using a spike-and-slab prior to model the latent distribution of a variational autoencoder&quot; --&gt;
&lt;h2 id=&apos;theory&apos;&gt;&lt;a href=&apos;#theory&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;VAE Overview&lt;/h2&gt;&lt;p&gt;Before diving into it, I thought I’d mention that I’ve included a quick refresher on the math behind variational autoencoders (VAE’s) at the end of this article if you’re feeling rusty ;)&lt;/p&gt;&lt;p&gt;Standard VAE’s use normal distributions everywhere, mainly since the math works out nicely when calculating posteriors. I was curious to see how this architecture would behave if instead I changed some underlying assumptions, and modeled the latent space using a &lt;a href=&apos;https://en.wikipedia.org/wiki/Spike-and-slab_regression&apos;&gt;spike-and-slab&lt;/a&gt; prior.&lt;/p&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/vae_post/mnist.gif&quot; style=&quot;width: 50%; display: block; margin: 0 auto;&quot;&gt;
&lt;/div&gt;
&lt;p&gt;Under this formulation we assume each latent, $z_{i}$, of the encoded sample, $x$, has some probability, $p$, of being turned “on” or “off”.  For $c\in \mathbb{R}$, $|c|&amp;lt;1$ we have for each dimension:&lt;/p&gt;&lt;div&gt;
$$
\begin{align*}
&amp; \gamma_{1}, \gamma_{2}, ..., \gamma_{d}|p \overset{iid}{\sim} Be(p) \\
&amp; z_{i} | \gamma_{i} \sim (1-\gamma_{i})\cdot \mathcal{N}(0, c^{2}) + \gamma_{i}\cdot \mathcal{N}(0, 1)
\end{align*}
$$
&lt;/div&gt;
&lt;p&gt;Our goal is to make the VAE learn how to encode and decode samples in a sparse fashion, i.e. where lots of info is “zeroed out”. Sparsity is nice mathematically and in a sec we’ll see what that looks like with a real demo on the MNIST dataset.&lt;/p&gt;&lt;p&gt;It’s important to observe that we can throttle the sparsity through our choice of $p$; $p=1$ means most of the embedding dimensions are uninformative, and $p=0$ recovers the original VAE. The edge cases aren’t that interesting so we’ll take a value in between, $0&amp;lt;p&amp;lt;1$.&lt;/p&gt;&lt;p&gt;We’ll also assume :&lt;/p&gt;&lt;ul&gt;&lt;li&gt;$z_{i}|x \sim \mathcal{N}(\mu_{\phi}(x),\sigma^{2}_{\phi}(x))$&lt;/li&gt;&lt;li&gt;and $x_{i}|z \sim Be(\theta(z))$.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;That last choice is mainly since I’m going to show some examples using grayscale images and we want our generated outputs being a value truncated between 0 and 1.&lt;/p&gt;&lt;!-- &gt; Notice that: $$p(z_{i}) = \int p(z_{i}, \gamma_{i})p(d\gamma_{i}) = (1-p)\cdot \varphi(x;0,c^{2}) + p\cdot \varphi(x;0,1)$$. --&gt;
&lt;p&gt;Okay so here’s the bad news: unfortunately no closed form for the KL-divergence between our mixture model prior and the posterior exists. The good news: we can just estimate the KL loss through &lt;a href=&quot;https://en.wikipedia.org/wiki/Monte_Carlo_method&quot;&gt;Monte Carlo&lt;/a&gt; pretty easily:&lt;/p&gt;&lt;div&gt;
$$
\begin{align*}
&amp; D_{KL}(q_{\phi}(z|x)||p(z)) = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \frac{q_{\phi}(z|x)}{p(z)}\right] \\
&amp;\approx \frac{1}{N}\sum_{i=1}^{N} \log q_{\phi}(z^{(i)}|x) - \log p(z^{(i)}), \quad z^{(i)}\sim q_{\phi}(\cdot | x)\\
\end{align*}
$$
&lt;/div&gt;
&lt;p&gt;One last thing, since we’re considering a Bernoulli framework for our probibalistic decoder, the first term in the ELBO breaks down to binary cross entropy (BCE) loss if we assume conditional independence. Indeed,&lt;/p&gt;&lt;div&gt;
$$
\begin{align*}
&amp; \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \prod_{i}p_{\theta}(x_{i}|z)\right]\\
&amp;\approx \sum_{i} \log \left( \theta_{i}(z))^{x_{i}}(1-\theta_{i}(z))^{(1-x_{i})}\right), \quad z \sim \mathcal{N}_{d}(\mu_{\phi}(x), \Sigma_{\phi}(x))\\
&amp; = \sum_{i} x_{i}\cdot \log(\theta_{i}(z)) + (1-x_{i})\cdot \log(1-\theta_{i}(z))\\
\end{align*}
$$
&lt;/div&gt;
&lt;p&gt;So we’re looking to minimize the binary cross entropy pixel-wise across the image! We can just use a classic &lt;code class=&apos;scode&apos;&gt;torch.nn.functional.binary_cross_entropy&lt;/code&gt; in the code for our reconstruction loss.&lt;/p&gt;&lt;h2 id=&apos;code&apos;&gt;&lt;a href=&apos;#code&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Basic PyTorch implementation&lt;/h2&gt;&lt;p&gt;Using PyTorch and torch.distributions we can easily implement everything we were just talking about.&lt;/p&gt;&lt;p&gt;First let’s handle the distributional aspects:&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource spython&quot;&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;skeyword scontrol simport sfrom spython&quot;&gt;from&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;smeta simport-source spython&quot;&gt; &lt;span class=&quot;smeta simport-path spython&quot;&gt;&lt;span class=&quot;smeta simport-name spython&quot;&gt;torch&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;skeyword scontrol simport spython&quot;&gt;import&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstatement simport spython&quot;&gt; &lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;nn&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;skeyword scontrol simport spython&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;distributions&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword scontrol simport sas spython&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;dist&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sstatement simport spython&quot;&gt;&lt;span class=&quot;skeyword scontrol simport spython&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;numpy&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword scontrol simport sas spython&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;np&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sclass spython&quot;&gt;&lt;span class=&quot;sstorage stype sclass spython&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;sentity sname sclass spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;SpikeAndSlab&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sclass sinheritance spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sinheritance sbegin spython&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sclass sinheritance spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sinheritance send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sclass spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sclass sbegin spython&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta sfunction spython&quot;&gt;    &lt;span class=&quot;sstorage stype sfunction spython&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;sentity sname sfunction spython&quot;&gt;&lt;span class=&quot;ssupport sfunction smagic spython&quot;&gt;__init__&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin spython&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;svariable sparameter spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;spike&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;slab&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sfunction sbegin spython&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;skeyword sother sassert spython&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;smeta sgroup spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;skeyword soperator scomparison spython&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator slogical spython&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;skeyword soperator scomparison spython&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sfunction spython&quot;&gt;    &lt;span class=&quot;sstorage stype sfunction spython&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;sentity sname sfunction spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;sample&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin spython&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;svariable sparameter spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;k&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters sdefault-value spython&quot;&gt;&lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sfunction sbegin spython&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;sample_one&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction sinline spython&quot;&gt;&lt;span class=&quot;sstorage stype sfunction sinline spython&quot;&gt;lambda&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sinline spython&quot;&gt;&lt;span class=&quot;smeta sfunction sinline sparameters spython&quot;&gt; &lt;/span&gt;&lt;span class=&quot;spunctuation ssection sfunction sbegin spython&quot;&gt;:&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;sample&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sgroup spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator stuple spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sstatement sif spython&quot;&gt;&lt;span class=&quot;skeyword scontrol sflow sconditional spython&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;uniform&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;skeyword soperator scomparison spython&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword scontrol sflow selse sinline spython&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;sample&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sgroup spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator stuple spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sstructure slist spython&quot;&gt;&lt;span class=&quot;spunctuation ssection slist sbegin spython&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;sample_one&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sexpression sgenerator spython&quot;&gt;&lt;span class=&quot;skeyword scontrol sflow sfor sgenerator spython&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;skeyword scontrol sflow sfor sin spython&quot;&gt;in&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;ssupport sfunction sbuiltin spython&quot;&gt;range&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;k&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection slist send spython&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;skeyword scontrol sflow sreturn spython&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;cat&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sfunction spython&quot;&gt;    &lt;span class=&quot;sstorage stype sfunction spython&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;sentity sname sfunction spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;log_prob&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin spython&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;svariable sparameter spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;samples&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sparameters send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sfunction sbegin spython&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; logsumexp :)
&lt;/span&gt;        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike_logit&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;tensor&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;log_prob&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab_logit&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;tensor&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable slanguage spython&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;log_prob&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

        &lt;span class=&quot;skeyword scontrol sflow sreturn spython&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;logsumexp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;cat&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sgroup spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike_logit&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;unsqueeze&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator stuple spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab_logit&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;unsqueeze&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta sfunction spython&quot;&gt;&lt;span class=&quot;sstorage stype sfunction spython&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;sentity sname sfunction spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;kl_divergence&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters sbegin spython&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;svariable sparameter spython&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sparameters spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;k&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters sdefault-value spython&quot;&gt;&lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction sparameters spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sparameters send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sfunction sbegin spython&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt; k sample monte carlo estimate for kl-divergence
&lt;/span&gt;    &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;sample&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sgroup spython&quot;&gt;&lt;span class=&quot;spunctuation ssection sgroup sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;k&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator stuple spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sgroup send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;skeyword scontrol sflow sreturn spython&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;mean&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;log_prob&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;log_prob&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;samples&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now for the loss terms:&lt;/p&gt;&lt;pre class=&apos;scode&apos;&gt;&lt;code&gt;&lt;span class=&quot;ssource spython&quot;&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;mu&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;log_var&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;vae_model&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;encoder&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;z&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;mu&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;exp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sfloat spython&quot;&gt;0&lt;span class=&quot;spunctuation sseparator sdecimal spython&quot;&gt;.&lt;/span&gt;5&lt;/span&gt;&lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;log_var&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;zeros_like&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;mu&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;normal_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;decoded&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;vae_model&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;decoder&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;z&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt;reconstruction loss
&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;recon&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;functional&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;binary_cross_entropy&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;decoded&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;data&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;svariable sparameter spython&quot;&gt;reduction&lt;/span&gt;&lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted ssingle spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition sstring sbegin spython&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta sstring spython&quot;&gt;&lt;span class=&quot;sstring squoted ssingle spython&quot;&gt;sum&lt;span class=&quot;spunctuation sdefinition sstring send spython&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt;kl divergence
&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;pz_x&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;dist&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;normal&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;Normal&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;mu&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;torch&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;exp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sfloat spython&quot;&gt;0&lt;span class=&quot;spunctuation sseparator sdecimal spython&quot;&gt;.&lt;/span&gt;5&lt;/span&gt;&lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;log_var&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sconstant snumeric sfloat spython&quot;&gt;0&lt;span class=&quot;spunctuation sseparator sdecimal spython&quot;&gt;.&lt;/span&gt;8&lt;/span&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;dist&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;normal&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;Normal&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;sqrt&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sfloat spython&quot;&gt;0&lt;span class=&quot;spunctuation sseparator sdecimal spython&quot;&gt;.&lt;/span&gt;05&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;dist&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;normal&lt;/span&gt;&lt;span class=&quot;spunctuation saccessor sdot spython&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;Normal&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;pz&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;SpikeAndSlab&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;spike&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;slab&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;p&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;kl&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta sfunction-call spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;svariable sfunction spython&quot;&gt;kl_divergence&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments sbegin spython&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;smeta sfunction-call sarguments spython&quot;&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;pz_x&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;pz&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation sseparator sarguments spython&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;svariable sparameter spython&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sconstant snumeric sinteger sdecimal spython&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;spunctuation ssection sarguments send spython&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;scomment sline snumber-sign spython&quot;&gt;&lt;span class=&quot;spunctuation sdefinition scomment spython&quot;&gt;#&lt;/span&gt;total loss
&lt;/span&gt;&lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;loss&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sassignment spython&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;recon&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;skeyword soperator sarithmetic spython&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;smeta squalified-name spython&quot;&gt;&lt;span class=&quot;smeta sgeneric-name spython&quot;&gt;kl&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I’ve left out the architectures for the encoder and decoder but since the MNIST dataset is fairly simple most choices will do. Notice also that we made use of the &lt;a href =&quot;https://en.wikipedia.org/wiki/LogSumExp&quot;&gt;LogSumExp trick&lt;/a&gt; to handle computing the log probabilities under the spike and slab prior.&lt;/p&gt;&lt;p&gt;With everything in place we can train the model quickly and visualize the resulting embedding space. I’ve left out the training details since this is more a post on the statistics side, but its in line with most tutorials out there.&lt;/p&gt;&lt;p&gt;When you train the model you still get a VAE which can produce realistic generations like the ones below, even if we’re using a lossy encoder.&lt;/p&gt;&lt;figure style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/vae_post/sparse_recon.png&quot; alt=&quot;VAE generations with spike-and-slab prior&quot; style=&quot;width: 100%; display: block; margin: 0 auto;&quot;&gt;
    &lt;figcaption&gt;
        Generations for a VAE with spike-and-slab prior; latent_dim = 10, p = 0.8, c² = 0.05
    &lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;What’s different about this model and the normal VAE is that when we encode images we only have a few non-zero components in the embedding representation.  If the embedding space is $d$-dimensional we expect the model to activate only $p*d$ dimensions after training, which we can see by looking at the image below:&lt;/p&gt;&lt;figure style=&quot;text-align: center;&quot;&gt;
    &lt;img src=&quot;/static/images/vae_post/latent_vis.png&quot;
         alt=&quot;Latent representations for different sample images using a trained model&quot;
         style=&quot;width: 100%; display: block; margin: 0 auto;&quot;&gt;
    &lt;figcaption&gt;
        Each subplot shows the latent representation for a different sample image using the trained model.
    &lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;There you go! A sparse variational autoencoder which was obtained just from making a few different choices in the statistical scaffolding of the model. I should also note that spike and slab and normal of course aren’t the only choices when designing your VAEs (personal fave of mine is Gumbel Softmax).&lt;/p&gt;&lt;h2 id=&apos;refresher&apos;&gt;&lt;a href=&apos;#refresher&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;Bonus: An in-depth refresher on VAE’s&lt;/h2&gt;&lt;p&gt;In terms of the original VAE proposed (rather offhandedly) by Kingma and Welling in 2014, the story goes something like this: suppose we want to learn the underlying distribution for some data (e.g. images) namely for the purpose of generating samples artificially. Just like in GANs we’d like to be able to convert some samples drawn from a parametric distribution into ones which might have come from our real data generator. This is where the &lt;strong&gt;probibalistic decoder&lt;/strong&gt;, $\theta$, comes into play. &lt;/p&gt;&lt;p&gt;The goal of $\theta$ is to map low-dimensional noise into hyperparameters of a parametric distribution which generates realistic high-dimensional samples.  Think $x|z \sim f(\theta(z))$&lt;/p&gt;&lt;p&gt;One way to quantify how “good” your decoder is performing is to compute the log probability of a real sample under the decoder framework as&lt;/p&gt;&lt;p&gt;$$ \log p_{\theta}(x) = \log  \int_{\mathcal{Z}}p_{\theta}(x,z)dz $$&lt;/p&gt;&lt;p&gt;If your decoder is doing its job, then the probability above should be high under your model.&lt;/p&gt;&lt;p&gt;Since this isn’t a really computationally tractable way to go about things however, another way to express the marginal is through &lt;em&gt;importance sampling&lt;/em&gt; w.r.t. the posterior distribution over the latents $z$ given a sample $x$ like&lt;/p&gt;&lt;div&gt;
$$
\log p_{\theta}(x) = \log \int_{\mathcal{Z}}p_{\theta}(x,z) \frac{p_{\theta}(z|x)}{p_{\theta}(z|x)}dz  = \log \mathbb{E}_{z\sim p_{\theta}(\cdot | x)}\left[\frac{p_{\theta}(x,z)}{p_{\theta}(z|x)}\right]
$$
&lt;/div&gt;
&lt;p&gt;where we’ve assumed that initially $ z\sim p(z) $ (&lt;em&gt;this is the part I’m interested in changing!)&lt;/em&gt;&lt;/p&gt;&lt;p&gt;Now this is where the authors got a little sneaky, instead of using the true posterior $p_{\theta}(z|x)$ we can instead come up with a proxy for it through the use of an &lt;strong&gt;probibalistic encoder&lt;/strong&gt;, $\phi$, which turns an input sample into hyperparameters used to model a parametric distribution over the latent space. Think $z|x \sim g(\phi(x))$.  With this we write the above as&lt;/p&gt;&lt;div&gt;
$$
\log p_{\theta}(x) = \log \mathbb{E}_{z\sim q_{\phi}(\cdot | x)}\left[\frac{p_{\theta}(x,z)}{q_{\phi}(z|x)}\right]
$$
&lt;/div&gt;
&lt;p&gt;Now by Jensen’s inequality (just geometry!) you arrive at a lower bound on the likelihood of a sample under our variational autoencoder given by the &lt;a href=&quot;https://en.wikipedia.org/wiki/Evidence_lower_bound&quot;&gt;evidence lower bound&lt;/a&gt;.&lt;/p&gt;&lt;div&gt;
$$
\begin{align*}
\log \mathbb{E}_{z\sim q_{\phi}(\cdot | x)}\left[\frac{p_{\theta}(x,z)}{q_{\phi}(z|x)}\right] &amp;\geq \mathbb{E}_{z\sim q_{\phi}(\cdot | x)}\left[\log  \frac{p_{\theta}(x,z)}{q_{\phi}(z|x)}\right]\\
&amp;:= \mathcal{L}(\theta, \phi; x)
\end{align*}
$$
&lt;/div&gt;
&lt;p&gt;Therefore maximimzing $\log p_{\theta}(x)$ becomes equivalent to maximizing the ELBO!&lt;/p&gt;&lt;p&gt;Fortunately enough there exists a much nicer representation for the ELBO which is a lot more approachable for us in terms of a numerical optimization perspective; starting (magically) from the KL-divergence between the latent posterior provided by the encoder and the associated prior we get&lt;/p&gt;&lt;div&gt;
$$
\begin{align*}
    &amp; D_{KL}(q_{\phi}(z|x)||p(z)) = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \frac{q_{\phi}(z|x)}{p(z)}\right]\\
    &amp;= \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \frac{q_{\phi}(z|x)}{p_{\theta}(x,z)p_{\theta}(x|z)^{-1}}\right]\\
    &amp;= -\mathcal{L}(\theta, \phi;x) + \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right]
\end{align*}
$$
&lt;/div&gt;
&lt;p&gt;so that&lt;/p&gt;&lt;div&gt;
$$
\mathcal{L}(\theta, \phi;x) =  \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] - D_{KL}(q_{\phi}(z|x)||p(z)) \tag{1}
$$
&lt;/div&gt;
&lt;p&gt;
Hmmm I guess this still looks a bit confusing.  To make the case for this model a little bit let&apos;s see what happens if we choose to model our probibalistic decoder such that $x|z \sim \mathcal{N}_{n}(\mu_{\theta}(z),1)$.
&lt;/p&gt;
In this case the first term on the right is proportional to
&lt;div&gt;
$$
\mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] \propto \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[-\frac{1}{2}(x-\mu_{\theta}(z))^{2}\right]
$$
&lt;/div&gt;
&lt;p&gt;So that maximizing this term is equivalent to minimizing the reconstruction loss.&lt;/p&gt;&lt;p&gt;By mixing and matching which probibalisitc frameworks you’re operating with for the encoder prior and posterior, and decoder posterior, the form of the ELBO changes accordingly.&lt;/p&gt;&lt;h2 id=&apos;references&apos;&gt;&lt;a href=&apos;#references&apos; class=&apos;anchor&apos;&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&apos;https://arxiv.org/abs/2106.09685&apos;&gt;Auto-Encoding Variational Bayes&lt;/a&gt; by Kingma et al. (2013)&lt;/li&gt;&lt;li&gt;&lt;a href=&apos;https://openreview.net/forum?id=Sy2fzU9gl&apos;&gt;beta-VAE: Learning Basic Visual Concepts with a Constrained Variational Framework&lt;/a&gt; by Higgins et al. (2022)&lt;/li&gt;&lt;/ul&gt;</content></entry></feed>