<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><meta content="dark light"name=color-scheme><meta content=#ffffff name=theme-color media=(prefers-color-scheme:light)><meta content=#000000 name=theme-color media=(prefers-color-scheme:dark)><meta content=nostromo property=og:site_name><link href=/static/logo.png rel=icon><link href=/apple-touch-icon.png rel=apple-touch-icon><link href=/common.css rel=stylesheet><script>window.MathJax={tex:{packages:{"[+]":["ams"]},inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><title>Fast byte pair encoding in rust - nostromo</title><meta content="Fast byte pair encoding in rust"property=og:title><meta content="In this article I’ll run through how I used Rust and pyo3 to implement a fast BPE tokenizer (4x faster than tokenizers and as fast as tiktoken) which you can install from PyPI today!"name=description><meta content=article property=og:type><link href=post.css rel=stylesheet><link href=feed.xml rel=alternate title=nostromo type=application/atom+xml></head><body><header><a href=/ class=name>nostromo</a><nav><a href=/blog/ >Blog</a></nav></header><main><p id=published><time datetime=2024-05-10>2024-05-10</time></p><h1>Fast byte pair encoding in rust</h1><blockquote id=description>An O(m*log n) optimization I found to speed up tokenizer throughput</blockquote><nav><ul><li><a href=#naive>A naive approach - <em>O(mn)</em></a></li><li><a href=#efficient>A better solution - <em>O(m log(n))</em></a></li><li><a href=#python-bindings>Python bindings</a></li></ul></nav><p>In this article I’ll run through how I used Rust and pyo3 to implement a fast BPE tokenizer (4x faster than <a href=https://github.com/huggingface/tokenizers>tokenizers</a> and as fast as <a href=https://github.com/openai/tiktoken>tiktoken</a>) which you can install from PyPI today!</p><p>All the code mentioned in this post can be found <a href=https://github.com/nnethercott/tok>on github</a>.</p><figure><div style=text-align:center><img src=/static/images/tok_post/performance.png style="width:80%;display:block;margin:0 auto"><figcaption>Speed comparison between my tokenizer (yellow) and popular libraries like Hugging Face and OpenAI</figcaption></div></figure><p>This article is about an efficient way I discovered to quickly encode and decode sequences using a pretrained tokenizer rather than an in-depth review of byte-pair encoding. For that feel free to check out any of these links: <a href=https://en.wikipedia.org/wiki/Byte_pair_encoding>wikipedia</a>, <a href=https://huggingface.co/learn/nlp-course/en/chapter6/5>huggingface</a>, <a href=https://github.com/openai/tiktoken>tiktoken</a>.</p><h2 id=naive><a href=#naive class=anchor></a>A naive approach - <em>O(mn)</em></h2><p>Suppose you’ve already trained a tokenizer (doing this is trivial), i.e. you have a some hashmap-like object that lets you map a sequence of bytes to unique tokens. What’s the fastest way to use this lookup table to encode and decode your data?</p><!-- ### A basic approach --><p>The easiest approach is to loop over all the possible token merges in the order we learned them and replace any matches we find along the way. For example, if your tokenizer has the following token mapping rules:</p><pre class=scode><code>{(97, 97): 128, (128,97): 129, (129, 98): 130}
</code></pre><p>Then the encoding for “aaabcaaab” (or [97,97,97,98,99,97,97,97,98] as a byte array) would look like this (notice how everything gets <em>compressed</em>):</p><pre class=scode><code>1. [97,97,97,98,99,97,97,97,98] -> [128,97,98,99,128,97,98]
2. [128,97,98,99,128,97,98] -> [129,98,99,129,98]
3. [129,98,99,129,98] -> [130,99,130]
</code></pre><p>In Rust you can write that loop as:</p><pre class=scode><code><span class="srust ssource"><span class="srust skeyword sother">use</span> <span class="srust smeta spath">std<span class="srust spunctuation saccessor">::</span></span><span class="srust smeta spath">collections<span class="srust spunctuation saccessor">::</span></span>HashMap<span class="srust spunctuation sterminator">;</span>
<span class="srust sstorage stype stype">type</span> <span class="srust sentity sname stype">Rank</span> <span class="srust skeyword soperator">=</span> <span class="srust sstorage stype">u32</span><span class="srust spunctuation sterminator">;</span>

<span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">_byte_pair_merge</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust sparameter svariable">pieces</span><span class="srust spunctuation sseparator">:</span> <span class="srust skeyword soperator">&</span><span class="srust sstorage smodifier">mut</span> <span class="srust smeta sgeneric">Vec<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span>, <span class="srust sparameter svariable">pair</span><span class="srust spunctuation sseparator">:</span> <span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust sparameter svariable">Rank</span><span class="srust spunctuation sseparator">,</span> <span class="srust sparameter svariable">Rank</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>, <span class="srust sparameter svariable">replace</span><span class="srust spunctuation sseparator">:</span> Rank</span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
    <span class="srust sstorage stype">let</span> <span class="srust sstorage smodifier">mut</span> i <span class="srust skeyword soperator">=</span> <span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation sterminator">;</span>
    <span class="srust skeyword scontrol">while</span> i <span class="srust skeyword soperator">&lt;</span> pieces.<span class="srust sfunction ssupport">len</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">-</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
        <span class="srust skeyword scontrol">if</span> <span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>i<span class="srust spunctuation ssection sgroup send">]</span></span><span class="srust spunctuation sseparator">,</span> pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>i <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation ssection sgroup send">]</span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">=</span><span class="srust skeyword soperator">=</span> pair <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
            pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>i<span class="srust spunctuation ssection sgroup send">]</span></span> <span class="srust skeyword soperator">=</span> replace<span class="srust spunctuation sterminator">;</span>
            pieces.<span class="srust sfunction ssupport">remove</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>i <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
        </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
        i <span class="srust skeyword soperator">+</span><span class="srust skeyword soperator">=</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>

<span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">encode</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust sparameter svariable">text</span><span class="srust spunctuation sseparator">:</span> <span class="srust skeyword soperator">&</span><span class="srust sstorage stype">str</span>, <span class="srust sparameter svariable">map</span><span class="srust spunctuation sseparator">:</span> <span class="srust skeyword soperator">&</span><span class="srust smeta sgeneric">HashMap<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span><span class="srust spunctuation ssection sgroup sbegin">(</span>Rank, Rank<span class="srust spunctuation ssection sgroup send">)</span>, Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta sgeneric">Vec<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span></span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
    <span class="srust sstorage stype">let</span> <span class="srust sstorage smodifier">mut</span> pieces<span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">Vec<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span> <span class="srust skeyword soperator">=</span> text.<span class="srust sfunction ssupport">as_bytes</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">iter</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">map</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust skeyword soperator">&</span><span class="srust sparameter svariable">x</span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure">x <span class="srust skeyword soperator">as</span> Rank</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">collect</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
    <span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span>reverse (k,v) to (v,k)
</span>    <span class="srust sstorage stype">let</span> reverse_map<span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">HashMap<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Rank, <span class="srust spunctuation ssection sgroup sbegin">(</span>Rank, Rank<span class="srust spunctuation ssection sgroup send">)</span><span class="srust spunctuation send sdefinition sgeneric">></span></span> <span class="srust skeyword soperator">=</span> map.<span class="srust sfunction ssupport">iter</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">map</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta">&<span class="srust sparameter svariable">p</span><span class="srust spunctuation sseparator">,</span> &<span class="srust sparameter svariable">r</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>r<span class="srust spunctuation sseparator">,</span> p</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">collect</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>

    <span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span>O(m*n)
</span>    <span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span>assume first token has index 128 since we're encoding for ascii
</span>    <span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sconstant sdecimal sinteger snumeric">128</span><span class="srust skeyword soperator">..</span><span class="srust skeyword soperator">=</span>reverse_map.<span class="srust sfunction ssupport">len</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">128</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">rev</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">for_each</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust sparameter svariable">i</span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
        <span class="srust sstorage stype">let</span> <span class="srust skeyword soperator">&</span>pair <span class="srust skeyword soperator">=</span> reverse_map.<span class="srust sfunction ssupport">get</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust skeyword soperator">&</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>i <span class="srust skeyword soperator">as</span> Rank</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">unwrap</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
        <span class="srust sfunction ssupport">_byte_pair_merge</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust skeyword soperator">&</span><span class="srust sstorage smodifier">mut</span> pieces<span class="srust spunctuation sseparator">,</span> pair<span class="srust spunctuation sseparator">,</span> i <span class="srust skeyword soperator">as</span> Rank</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>

    pieces
</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
</span></code></pre><p>For a vocabulary size of 50257, the token throughput with this approach for a 2.5MB subset of the <a href=https://huggingface.co/datasets/wikitext>wikitext dataset</a> is somewhere in the neighborhood of <strong>0.09MB/s</strong>.</p><p>This approach definitely gets the job done but it’s incredibly inefficient! Indeed, this solution has a time complexity of $O(mn)$, where $m$ is the vocab size and $n$ is the length of the text you want to encode. As the vocabulary size and/or length of the text increase we get significant slowdowns.</p><h2 id=efficient><a href=#efficient class=anchor></a>A better solution - <em>O(m log(n))</em></h2><p>The approach I ended up stumbling across after around 6 hours of refactoring is closer to $O(m\log{n})$. It relies on the fact that we don’t need to loop over every entry in the hashmap when it’s sufficient to notice that we can apply merges in a way which respects the order the tokenizer learned them in. This lets us apply multiple different token merges in a single pass instead of only searching for a single pattern each time. We can also detect early on if no more token merging is possible and break out of the function.</p><p>If you’ve been grinding your fair share of Leetcode this sort of <a href=https://www.geeksforgeeks.org/dsa/two-pointers-technique/ >two-pointers approach</a> should feel familiar…</p><pre class=scode><code><span class="srust ssource"><span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span>lib.rs
</span><span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">encode</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust sparameter svariable">text</span><span class="srust spunctuation sseparator">:</span> <span class="srust skeyword soperator">&</span><span class="srust sstorage stype">str</span>, <span class="srust sparameter svariable">map</span><span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">Map<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span><span class="srust spunctuation ssection sgroup sbegin">(</span>Rank, Rank<span class="srust spunctuation ssection sgroup send">)</span>, Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta sgeneric">Vec<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span></span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
    <span class="srust sstorage stype">let</span> <span class="srust sstorage smodifier">mut</span> pieces<span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">Vec<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Rank<span class="srust spunctuation send sdefinition sgeneric">></span></span> <span class="srust skeyword soperator">=</span> text.<span class="srust sfunction ssupport">as_bytes</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">iter</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">map</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust skeyword soperator">&</span><span class="srust sparameter svariable">x</span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure">x <span class="srust skeyword soperator">as</span> Rank</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">collect</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>

    <span class="srust skeyword scontrol">loop</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
        <span class="srust sstorage stype">let</span> <span class="srust sstorage smodifier">mut</span> merges <span class="srust skeyword soperator">=</span> <span class="srust ssupport stype">Vec</span><span class="srust smeta spath"><span class="srust spunctuation saccessor">::</span></span>new<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
        <span class="srust skeyword scontrol">for</span> i <span class="srust skeyword soperator">in</span> <span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust skeyword soperator">..</span>pieces.<span class="srust sfunction ssupport">len</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">-</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
            <span class="srust skeyword scontrol">if</span> <span class="srust sstorage stype">let</span> <span class="srust ssupport stype">Some</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust skeyword soperator">&</span>rank</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">=</span> map.<span class="srust sfunction ssupport">get</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust skeyword soperator">&</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>i<span class="srust spunctuation ssection sgroup send">]</span></span><span class="srust spunctuation sseparator">,</span> pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>i <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation ssection sgroup send">]</span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
                merges.<span class="srust sfunction ssupport">push</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>i<span class="srust spunctuation sseparator">,</span> rank</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
            </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
        </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
        <span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span>early stopping
</span>        <span class="srust skeyword scontrol">if</span> merges.<span class="srust sfunction ssupport">is_empty</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
            <span class="srust skeyword scontrol">break</span><span class="srust spunctuation sterminator">;</span>
        </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>

        <span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span> apply merges and swap in tokens from reverse
</span>        <span class="srust sstorage stype">let</span> <span class="srust sstorage smodifier">mut</span> i <span class="srust skeyword soperator">=</span> merges.<span class="srust sfunction ssupport">len</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">-</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
        <span class="srust skeyword scontrol">while</span> i <span class="srust skeyword soperator">></span> <span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
            <span class="srust sstorage stype">let</span> x <span class="srust skeyword soperator">=</span> <span class="srust skeyword soperator">&</span><span class="srust sstorage smodifier">mut</span> merges<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>i <span class="srust skeyword soperator">-</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust skeyword soperator">..</span><span class="srust skeyword soperator">=</span>i<span class="srust spunctuation ssection sgroup send">]</span></span><span class="srust spunctuation sterminator">;</span>
            <span class="srust sstorage stype">let</span> l <span class="srust skeyword soperator">=</span> x<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span><span class="srust spunctuation sterminator">;</span>
            <span class="srust sstorage stype">let</span> r <span class="srust skeyword soperator">=</span> x<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation ssection sgroup send">]</span></span><span class="srust spunctuation sterminator">;</span>

            <span class="srust skeyword scontrol">if</span> r.<span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust skeyword soperator">-</span> l.<span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust skeyword soperator">></span> <span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust skeyword soperator">&</span><span class="srust skeyword soperator">&</span> r.<span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust skeyword soperator">!</span><span class="srust skeyword soperator">=</span> <span class="srust smeta spath">Rank<span class="srust spunctuation saccessor">::</span></span><span class="srust sconstant sother">MAX</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
                pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>r.<span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span> <span class="srust skeyword soperator">=</span> r.<span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
                pieces.<span class="srust sfunction ssupport">remove</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>r.<span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
            </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span> <span class="srust skeyword scontrol">else</span> <span class="srust skeyword scontrol">if</span> r.<span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust skeyword soperator">&lt;</span> l.<span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
                pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>r.<span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span> <span class="srust skeyword soperator">=</span> r.<span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
                pieces.<span class="srust sfunction ssupport">remove</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>r.<span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>

                x<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span>.<span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">Rank<span class="srust spunctuation saccessor">::</span></span><span class="srust sconstant sother">MAX</span><span class="srust spunctuation sterminator">;</span>
                i <span class="srust skeyword soperator">-</span><span class="srust skeyword soperator">=</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
            </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
            <span class="srust scomment sdouble-slash sline"><span class="srust spunctuation sdefinition scomment">//</span>avoid overflow on usize 0-1
</span>            <span class="srust skeyword scontrol">if</span> i <span class="srust skeyword soperator">=</span><span class="srust skeyword soperator">=</span> <span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
                <span class="srust skeyword scontrol">break</span><span class="srust spunctuation sterminator">;</span>
            </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
            i <span class="srust skeyword soperator">-</span><span class="srust skeyword soperator">=</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
        </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
        <span class="srust skeyword scontrol">if</span> merges.<span class="srust sfunction ssupport">len</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">=</span><span class="srust skeyword soperator">=</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust skeyword soperator">|</span><span class="srust skeyword soperator">|</span> merges<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span>.<span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust skeyword soperator">&lt;</span> merges<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation ssection sgroup send">]</span></span>.<span class="srust sconstant sdecimal sinteger snumeric">1</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
            pieces<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span>merges<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span>.<span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span> <span class="srust skeyword soperator">=</span> merges<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span>.<span class="srust sconstant sdecimal sinteger snumeric">1</span><span class="srust spunctuation sterminator">;</span>
            pieces.<span class="srust sfunction ssupport">remove</span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">(</span>merges<span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup sbegin">[</span><span class="srust sconstant sdecimal sinteger snumeric">0</span><span class="srust spunctuation ssection sgroup send">]</span></span>.<span class="srust sconstant sdecimal sinteger snumeric">0</span> <span class="srust skeyword soperator">+</span> <span class="srust sconstant sdecimal sinteger snumeric">1</span></span><span class="srust sgroup smeta"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
        </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
    pieces
</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
</span></code></pre><p>On the same wikitext split our throughput using this encoding algorithm jumps to <strong>24.35MB/s</strong>. That’s over a 100x improvement with respect to where we started from.</p><p>I took a lot of inspiration from official <a href=https://github.com/openai/tiktoken/blob/main/src/lib.rs>openai implementation</a> in their repo <code class=scode>tiktoken</code> but handled the merging aspect quite differently by leveraging the fact that we could store the prospective merges in a stack instead of finding the single-best merge at each iteration.</p><h2 id=python-bindings><a href=#python-bindings class=anchor></a>Python bindings</h2><p>To expose the Rust code in Python I made use of <a href=https://github.com/PyO3/pyo3>pyo3</a> and <a href=https://github.com/PyO3/maturin>maturin</a>. Getting started with these libraries is incredibly easy and just requires adding a few pyo3 attributes to your existing rust code. What’s also nice is that maturin automatically adds a CI workflow to your project which makes distributing your python package infinitely easier. By default the workflow listens for new tag pushes to the main branch and builds the wheels for all the major platforms.</p><p>I encourage you to check out <a href=https://github.com/PyO3/setuptools-rust/tree/main/examples>a few official examples</a> and the <a href=https://pyo3.rs/v0.21.2/ >pyo3 docs</a>, overall though its a pretty frictionless experience.</p><p>Using maturin I published <a href=https://pypi.org/project/toktokenizer/ ><code class=scode>toktokenizer</code></a> - a lightweight python package for BPE tokenizers - to PyPI. The only class the library exposes is <code class=scode>BPETokenizer</code>. The class itself is pretty minimal, with all major methods being showed below:</p><pre class=scode><code><span class="spython ssource"><span class="spython scomment sline snumber-sign"><span class="spunctuation sdefinition spython scomment">#</span> demo.py
</span><span class="smeta spython simport sstatement"><span class="spython simport scontrol skeyword sfrom">from</span></span><span class="smeta spython simport sstatement"><span class="smeta spython simport-source"> <span class="smeta spython simport-path"><span class="smeta spython simport-name">toktokenizer</span></span> <span class="smeta spython simport sstatement"><span class="spython simport scontrol skeyword">import</span></span></span></span><span class="smeta spython simport sstatement"></span><span class="smeta spython simport sstatement"> <span class="smeta spython sgeneric-name">BPETokenizer</span></span>

<span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">bpe</span></span> <span class="spython skeyword sassignment soperator">=</span> <span class="smeta spython sfunction-call"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">tok</span><span class="spunctuation saccessor sdot spython">.</span></span><span class="smeta spython squalified-name"><span class="spython sfunction svariable">BPETokenizer</span></span><span class="spunctuation ssection sbegin sarguments spython">(</span><span class="spunctuation ssection send sarguments spython">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spunctuation sdefinition spython scomment">#</span> train a byte-pair tokenizer on some corpus
</span><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">train_corpus</span></span> <span class="spython skeyword sassignment soperator">=</span> <span class="smeta spython sstring"><span class="spython sstring sdouble squoted"><span class="spunctuation sbegin sdefinition spython sstring">"</span></span></span><span class="smeta spython sstring"><span class="spython sstring sdouble squoted">this is some training data<span class="spunctuation send sdefinition spython sstring">"</span></span></span>
<span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">vocab_size</span></span> <span class="spython skeyword sassignment soperator">=</span> <span class="spython sconstant sdecimal sinteger snumeric">8</span>
<span class="smeta spython sfunction-call"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">bpe</span><span class="spunctuation saccessor sdot spython">.</span></span><span class="smeta spython squalified-name"><span class="spython sfunction svariable">train</span></span><span class="spunctuation ssection sbegin sarguments spython">(</span><span class="smeta spython sfunction-call sarguments"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">train_corpus</span></span><span class="spunctuation sseparator sarguments spython">,</span> <span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">vocab_size</span></span></span><span class="spunctuation ssection send sarguments spython">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spunctuation sdefinition spython scomment">#</span> save tokenizer state
</span><span class="smeta spython sfunction-call"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">bpe</span><span class="spunctuation saccessor sdot spython">.</span></span><span class="smeta spython squalified-name"><span class="spython sfunction svariable">save_encoder</span></span><span class="spunctuation ssection sbegin sarguments spython">(</span><span class="smeta spython sfunction-call sarguments"><span class="smeta spython sstring"><span class="spython sstring sdouble squoted"><span class="spunctuation sbegin sdefinition spython sstring">"</span></span></span><span class="smeta spython sstring"><span class="spython sstring sdouble squoted">8word.json<span class="spunctuation send sdefinition spython sstring">"</span></span></span></span><span class="spunctuation ssection send sarguments spython">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spunctuation sdefinition spython scomment">#</span> load tokenizer from dumped file
</span><span class="smeta spython sfunction-call"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">bpe</span><span class="spunctuation saccessor sdot spython">.</span></span><span class="smeta spython squalified-name"><span class="spython sfunction svariable">load_encoder</span></span><span class="spunctuation ssection sbegin sarguments spython">(</span><span class="smeta spython sfunction-call sarguments"><span class="smeta spython sstring"><span class="spython sstring sdouble squoted"><span class="spunctuation sbegin sdefinition spython sstring">"</span></span></span><span class="smeta spython sstring"><span class="spython sstring sdouble squoted">8word.json<span class="spunctuation send sdefinition spython sstring">"</span></span></span></span><span class="spunctuation ssection send sarguments spython">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spunctuation sdefinition spython scomment">#</span> encode and decode
</span><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">input_ids</span></span> <span class="spython skeyword sassignment soperator">=</span> <span class="smeta spython sfunction-call"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">bpe</span><span class="spunctuation saccessor sdot spython">.</span></span><span class="smeta spython squalified-name"><span class="spython sfunction svariable">encode</span></span><span class="spunctuation ssection sbegin sarguments spython">(</span><span class="smeta spython sfunction-call sarguments"><span class="smeta spython sstring"><span class="spython sstring sdouble squoted"><span class="spunctuation sbegin sdefinition spython sstring">"</span></span></span><span class="smeta spython sstring"><span class="spython sstring sdouble squoted">some data<span class="spunctuation send sdefinition spython sstring">"</span></span></span></span><span class="spunctuation ssection send sarguments spython">)</span></span>
<span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">decoded</span></span> <span class="spython skeyword sassignment soperator">=</span> <span class="smeta spython sfunction-call"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">bpe</span><span class="spunctuation saccessor sdot spython">.</span></span><span class="smeta spython squalified-name"><span class="spython sfunction svariable">decode</span></span><span class="spunctuation ssection sbegin sarguments spython">(</span><span class="smeta spython sfunction-call sarguments"><span class="smeta spython squalified-name"><span class="smeta spython sgeneric-name">input_ids</span></span></span><span class="spunctuation ssection send sarguments spython">)</span></span>
</span></code></pre><p>To get started with <code class=scode>toktokenizer</code> today you can install it with pip as follows:</p><pre class=scode><code>pip install toktokenizer
</code></pre><p>I’m looking forward to using this library moving forwards as I build up various components of modern NLP models from scratch!</p><p class=back><a href=#>⮬ Back to top</a></p></main></body></html>