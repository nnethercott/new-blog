<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><meta content="dark light"name=color-scheme><meta content=#ffffff name=theme-color media=(prefers-color-scheme:light)><meta content=#000000 name=theme-color media=(prefers-color-scheme:dark)><meta content="Nate Nethercott"property=og:site_name><link href=/favicon.ico rel=icon><link href=/apple-touch-icon.png rel=apple-touch-icon><link href=/common.css rel=stylesheet><script>window.MathJax={tex:{packages:{"[+]":["ams"]},inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><title>Sparse Bayesian priors + VAE’s - Nate Nethercott</title><meta content="Sparse Bayesian priors + VAE’s"property=og:title><meta content="Before diving into it, I thought I’d mention that I’ve included a quick refresher on the math behind variational autoencoders (VAE’s) at the end of this article if you’re feeling rusty ;)"name=description><meta content=article property=og:type><link href=post.css rel=stylesheet><link href=feed.xml rel=alternate title="Nate Nethercott's Blog"type=application/atom+xml></head><body><header><a href=/ class=name>Nate Nethercott</a><nav><a href=/blog/ >Blog</a></nav></header><main><p id=published><time datetime=2023-10-23>2023-10-23</time></p><h1>Sparse Bayesian priors + VAE’s</h1><blockquote id=description>Using a spike-and-slab prior to model the latent distribution of a variational autoencoder</blockquote><nav><ul><li><a href=#theory>Theory</a></li><li><a href=#code>Code</a></li><li><a href=#refresher>Quick refresher on VAE’s</a></li><li><a href=#references>References</a></li></ul></nav><h2 id=theory><a href=#theory class=anchor></a>Theory</h2><p>Before diving into it, I thought I’d mention that I’ve included a quick refresher on the math behind variational autoencoders (VAE’s) at the end of this article if you’re feeling rusty ;)</p><p>Standard VAE’s use normal distributions everywhere, mainly since the math works out nicely when calculating posteriors. I was curious to see how this architecture would behave if instead I changed some underlying assumptions, and modeled the latent space using a <a href=https://en.wikipedia.org/wiki/Spike-and-slab_regression>“spike-and-slab”</a> prior.</p><div style=text-align:center><img src=/static/images/vae_post/mnist.gif style="width:50%;display:block;margin:0 auto"></div><p>Under this formulation we assume each latent, $z_{i}$, of the encoded sample, $x$, has some probability, $p$, of being turned “on” or “off”. For $c\in \mathbb{R}$, $|c|&lt;1$ we have for each dimension:</p><div>$$ \begin{align*} & \gamma_{1}, \gamma_{2}, ..., \gamma_{d}|p \overset{iid}{\sim} Be(p) \\ & z_{i} | \gamma_{i} \sim (1-\gamma_{i})\cdot \mathcal{N}(0, c^{2}) + \gamma_{i}\cdot \mathcal{N}(0, 1) \end{align*} $$</div><p>Our goal is to make the VAE learn how to encode and decode samples in a sparse fashion, i.e. where lots of info is “zeroed out”. Sparsity is nice mathematically and in a sec we’ll see what that looks like with a real demo on the MNIST dataset. Also observe that we can throttle the sparsity through our choice of $p$; $p=1$ means most of the embedding dimensions are uninformative, and $p=0$ recovers the original VAE. The edge cases aren’t that interesting so we’ll take a value in between, $0&lt;p&lt;1$.</p><p>We’ll also assume :</p><ul><li>$z_{i}|x \sim \mathcal{N}(\mu_{\phi}(x),\sigma^{2}_{\phi}(x))$</li><li>and $x_{i}|z \sim Be(\theta(z))$.</li></ul><p>That last choice is mainly since I’m going to show some examples using grayscale images and we want our generated outputs being a value truncated between 0 and 1.</p><p>Okay so here’s the bad news: unfortunately no closed form for the KL-divergence between our mixture model prior and the posterior exists. The good news: we can just estimate the KL loss through <a href=https://en.wikipedia.org/wiki/Monte_Carlo_method>Monte Carlo</a> pretty easily:</p><div>$$ \begin{align*} & D_{KL}(q_{\phi}(z|x)||p(z)) = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \frac{q_{\phi}(z|x)}{p(z)}\right] \\ &\approx \frac{1}{N}\sum_{i=1}^{N} \log q_{\phi}(z^{(i)}|x) - \log p(z^{(i)}), \quad z^{(i)}\sim q_{\phi}(\cdot | x)\\ \end{align*} $$</div><p>One last thing, since we’re considering a Bernoulli framework for our probibalistic decoder, the first term in the ELBO breaks down to binary cross entropy (BCE) loss if we assume conditional independence. Indeed,</p><div>$$ \begin{align*} & \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \prod_{i}p_{\theta}(x_{i}|z)\right]\\ &\approx \sum_{i} \log \left( \theta_{i}(z))^{x_{i}}(1-\theta_{i}(z))^{(1-x_{i})}\right), \quad z \sim \mathcal{N}_{d}(\mu_{\phi}(x), \Sigma_{\phi}(x))\\ & = \sum_{i} x_{i}\cdot \log(\theta_{i}(z)) + (1-x_{i})\cdot \log(1-\theta_{i}(z))\\ \end{align*} $$</div><p>So we’re looking to minimize the binary cross entropy pixel-wise across the image! We can just use a classic <code class=scode>torch.nn.functional.binary_cross_entropy</code> in the code for our reconstruction loss.</p><h2 id=code><a href=#code class=anchor></a>Code</h2><p>Using PyTorch and torch.distributions we can easily implement everything we were just talking about.</p><p>First let’s handle the distributional aspects:</p><pre class=scode><code><span class="spython ssource"><span class="spython smeta sstatement simport"><span class="spython skeyword scontrol simport sfrom">from</span></span><span class="spython smeta sstatement simport"><span class="spython smeta simport-source"> <span class="spython smeta simport-path"><span class="spython smeta simport-name">torch</span></span> <span class="spython smeta sstatement simport"><span class="spython skeyword scontrol simport">import</span></span></span></span><span class="spython smeta sstatement simport"></span><span class="spython smeta sstatement simport"> <span class="spython smeta sgeneric-name">nn</span></span>
<span class="spython smeta sstatement simport"><span class="spython skeyword scontrol simport">import</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">distributions</span></span> <span class="spython skeyword scontrol simport sas">as</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">dist</span></span></span>
<span class="spython smeta sstatement simport"><span class="spython skeyword scontrol simport">import</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">numpy</span></span> <span class="spython skeyword scontrol simport sas">as</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">np</span></span></span>

<span class="spython smeta sclass"><span class="spython sclass sstorage stype">class</span> <span class="spython sclass sentity sname"><span class="spython smeta sgeneric-name">SpikeAndSlab</span></span><span class="spython smeta sclass sinheritance"><span class="spython spunctuation ssection sbegin sinheritance">(</span></span></span><span class="spython smeta sclass sinheritance"><span class="spython spunctuation ssection send sinheritance">)</span></span><span class="spython smeta sclass"><span class="spython spunctuation ssection sbegin sclass">:</span></span>
<span class="spython smeta sfunction">    <span class="spython sfunction sstorage stype">def</span> <span class="spython sfunction sentity sname"><span class="spython sfunction ssupport smagic">__init__</span></span></span><span class="spython smeta sfunction sparameters"><span class="spython spunctuation ssection sbegin sparameters">(</span></span><span class="spython smeta sfunction sparameters"><span class="spython svariable sparameter">self</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">spike</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">slab</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">p</span><span class="spython spunctuation ssection send sparameters">)</span></span><span class="spython smeta sfunction"><span class="spython spunctuation ssection sbegin sfunction">:</span></span>
        <span class="spython skeyword sassert sother">assert</span><span class="spython smeta sgroup"><span class="spython spunctuation ssection sbegin sgroup">(</span><span class="spython sconstant snumeric sdecimal sinteger">0</span><span class="spython skeyword soperator scomparison">&lt;=</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">p</span></span> <span class="spython skeyword soperator slogical">and</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">p</span></span><span class="spython skeyword soperator scomparison">&lt;=</span><span class="spython sconstant snumeric sdecimal sinteger">1</span><span class="spython spunctuation ssection send sgroup">)</span></span>

        <span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">spike</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">spike</span></span>
        <span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">slab</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">slab</span></span>
        <span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">p</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">p</span></span>

<span class="spython smeta sfunction">    <span class="spython sfunction sstorage stype">def</span> <span class="spython sfunction sentity sname"><span class="spython smeta sgeneric-name">sample</span></span></span><span class="spython smeta sfunction sparameters"><span class="spython spunctuation ssection sbegin sparameters">(</span></span><span class="spython smeta sfunction sparameters"><span class="spython svariable sparameter">self</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">k</span></span><span class="spython smeta sfunction sparameters sdefault-value"><span class="spython skeyword soperator sassignment">=</span><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython smeta sfunction sparameters"><span class="spython spunctuation ssection send sparameters">)</span></span><span class="spython smeta sfunction"><span class="spython spunctuation ssection sbegin sfunction">:</span></span>
        <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">sample_one</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction sinline"><span class="spython sfunction sstorage stype sinline">lambda</span></span><span class="spython smeta sfunction sinline"><span class="spython smeta sfunction sparameters sinline"> </span><span class="spython spunctuation ssection sbegin sfunction">:</span></span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">spike</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">sample</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sgroup"><span class="spython spunctuation ssection sbegin sgroup">(</span><span class="spython sconstant snumeric sdecimal sinteger">1</span><span class="spython spunctuation sseparator stuple">,</span><span class="spython spunctuation ssection send sgroup">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span> <span class="spython smeta sstatement sif"><span class="spython skeyword scontrol sflow sconditional">if</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">np</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">random</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">uniform</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sdecimal sinteger">0</span><span class="spython spunctuation sarguments sseparator">,</span><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython skeyword soperator scomparison">&lt;</span><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">p</span></span> <span class="spython skeyword scontrol sflow selse sinline">else</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">slab</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">sample</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sgroup"><span class="spython spunctuation ssection sbegin sgroup">(</span><span class="spython sconstant snumeric sdecimal sinteger">1</span><span class="spython spunctuation sseparator stuple">,</span><span class="spython spunctuation ssection send sgroup">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span></span>
        <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta slist sstructure"><span class="spython spunctuation ssection sbegin slist">[</span><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython sfunction svariable">sample_one</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython spunctuation ssection sarguments send">)</span></span> <span class="spython smeta sexpression sgenerator"><span class="spython skeyword scontrol sflow sfor sgenerator">for</span> <span class="spython smeta sgeneric-name">i</span> <span class="spython skeyword scontrol sflow sfor sin">in</span></span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython sfunction ssupport sbuiltin">range</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">k</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython spunctuation ssection send slist">]</span></span>
        <span class="spython skeyword scontrol sflow sreturn">return</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">cat</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython smeta sfunction">    <span class="spython sfunction sstorage stype">def</span> <span class="spython sfunction sentity sname"><span class="spython smeta sgeneric-name">log_prob</span></span></span><span class="spython smeta sfunction sparameters"><span class="spython spunctuation ssection sbegin sparameters">(</span></span><span class="spython smeta sfunction sparameters"><span class="spython svariable sparameter">self</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">samples</span><span class="spython spunctuation ssection send sparameters">)</span></span><span class="spython smeta sfunction"><span class="spython spunctuation ssection sbegin sfunction">:</span></span>
        <span class="spython scomment sline snumber-sign"><span class="spython spunctuation sdefinition scomment">#</span> logsumexp :)
</span>        <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">spike_logit</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">log</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">tensor</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">p</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span> <span class="spython skeyword soperator sarithmetic">+</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">spike</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">log_prob</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>
        <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">slab_logit</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">log</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">tensor</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sdecimal sinteger">1</span><span class="spython skeyword soperator sarithmetic">-</span><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">p</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span> <span class="spython skeyword soperator sarithmetic">+</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython svariable slanguage">self</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">slab</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">log_prob</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

        <span class="spython skeyword scontrol sflow sreturn">return</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">logsumexp</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">cat</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sgroup"><span class="spython spunctuation ssection sbegin sgroup">(</span><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">spike_logit</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">unsqueeze</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython spunctuation sseparator stuple">,</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">slab_logit</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">unsqueeze</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython spunctuation ssection send sgroup">)</span></span><span class="spython spunctuation sarguments sseparator">,</span><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython spunctuation sarguments sseparator">,</span><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython smeta sfunction"><span class="spython sfunction sstorage stype">def</span> <span class="spython sfunction sentity sname"><span class="spython smeta sgeneric-name">kl_divergence</span></span></span><span class="spython smeta sfunction sparameters"><span class="spython spunctuation ssection sbegin sparameters">(</span></span><span class="spython smeta sfunction sparameters"><span class="spython svariable sparameter">q</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">p</span><span class="spython spunctuation sseparator sparameters">,</span> <span class="spython svariable sparameter">k</span></span><span class="spython smeta sfunction sparameters sdefault-value"><span class="spython skeyword soperator sassignment">=</span><span class="spython sconstant snumeric sdecimal sinteger">10</span></span><span class="spython smeta sfunction sparameters"><span class="spython spunctuation ssection send sparameters">)</span></span><span class="spython smeta sfunction"><span class="spython spunctuation ssection sbegin sfunction">:</span></span>
    <span class="spython scomment sline snumber-sign"><span class="spython spunctuation sdefinition scomment">#</span> k sample monte carlo estimate for kl-divergence
</span>    <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">q</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">sample</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sgroup"><span class="spython spunctuation ssection sbegin sgroup">(</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">k</span></span><span class="spython spunctuation sseparator stuple">,</span><span class="spython spunctuation ssection send sgroup">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>
    <span class="spython skeyword scontrol sflow sreturn">return</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">mean</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">q</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">log_prob</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span> <span class="spython skeyword soperator sarithmetic">-</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">p</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">log_prob</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">samples</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>
</span></code></pre><p>Now for the loss terms:</p><pre class=scode><code><span class="spython ssource">
<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">mu</span></span>, <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">log_var</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">vae_model</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">encoder</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">x</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">z</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">mu</span></span> <span class="spython skeyword soperator sarithmetic">+</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">exp</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sfloat">0<span class="spython spunctuation sseparator sdecimal">.</span>5</span><span class="spython skeyword soperator sarithmetic">*</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">log_var</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython skeyword soperator sarithmetic">*</span><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">zeros_like</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">mu</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">normal_</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython spunctuation ssection sarguments send">)</span></span>
<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">decoded</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">vae_model</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">decoder</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">z</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spython spunctuation sdefinition scomment">#</span>reconstruction loss
</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">recon</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">nn</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">functional</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">binary_cross_entropy</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">decoded</span></span><span class="spython spunctuation sarguments sseparator">,</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">data</span></span><span class="spython spunctuation sarguments sseparator">,</span> <span class="spython svariable sparameter">reduction</span><span class="spython skeyword soperator sassignment">=</span><span class="spython smeta sstring"><span class="spython sstring squoted ssingle"><span class="spython spunctuation sdefinition sstring sbegin">'</span></span></span><span class="spython smeta sstring"><span class="spython sstring squoted ssingle">sum<span class="spython spunctuation sdefinition sstring send">'</span></span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spython spunctuation sdefinition scomment">#</span>kl divergence
</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">pz_x</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">dist</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">normal</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">Normal</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">mu</span></span><span class="spython spunctuation sarguments sseparator">,</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">torch</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">exp</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sfloat">0<span class="spython spunctuation sseparator sdecimal">.</span>5</span><span class="spython skeyword soperator sarithmetic">*</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">log_var</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">p</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython sconstant snumeric sfloat">0<span class="spython spunctuation sseparator sdecimal">.</span>8</span>
<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">spike</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">dist</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">normal</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">Normal</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sdecimal sinteger">0</span><span class="spython spunctuation sarguments sseparator">,</span><span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">np</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">sqrt</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sfloat">0<span class="spython spunctuation sseparator sdecimal">.</span>05</span></span><span class="spython spunctuation ssection sarguments send">)</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>
<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">slab</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">dist</span><span class="spython spunctuation saccessor sdot">.</span><span class="spython smeta sgeneric-name">normal</span><span class="spython spunctuation saccessor sdot">.</span></span><span class="spython smeta squalified-name"><span class="spython sfunction svariable">Normal</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython sconstant snumeric sdecimal sinteger">0</span><span class="spython spunctuation sarguments sseparator">,</span><span class="spython sconstant snumeric sdecimal sinteger">1</span></span><span class="spython spunctuation ssection sarguments send">)</span></span>
<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">pz</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython sfunction svariable">SpikeAndSlab</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">spike</span></span><span class="spython spunctuation sarguments sseparator">,</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">slab</span></span><span class="spython spunctuation sarguments sseparator">,</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">p</span></span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">kl</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta sfunction-call"><span class="spython smeta squalified-name"><span class="spython sfunction svariable">kl_divergence</span></span><span class="spython spunctuation ssection sarguments sbegin">(</span><span class="spython smeta sfunction-call sarguments"><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">pz_x</span></span><span class="spython spunctuation sarguments sseparator">,</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">pz</span></span><span class="spython spunctuation sarguments sseparator">,</span><span class="spython svariable sparameter">k</span><span class="spython skeyword soperator sassignment">=</span><span class="spython sconstant snumeric sdecimal sinteger">10</span></span><span class="spython spunctuation ssection sarguments send">)</span></span>

<span class="spython scomment sline snumber-sign"><span class="spython spunctuation sdefinition scomment">#</span>total loss
</span><span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">loss</span></span> <span class="spython skeyword soperator sassignment">=</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">recon</span></span> <span class="spython skeyword soperator sarithmetic">+</span> <span class="spython smeta squalified-name"><span class="spython smeta sgeneric-name">kl</span></span>
</span></code></pre><p>I’ve left out the architectures for the encoder and decoder but since the MNIST dataset is fairly simple most choices will do. Notice also that we made use of the <a href=https://en.wikipedia.org/wiki/LogSumExp>LogSumExp trick</a> to handle computing the log probabilities under the spike and slab prior.</p><p>With everything in place we can train the model quickly and visualize the resulting embedding space. I’ve left out the training details since this is more a post on the statistics side, but its in line with most tutorials out there.</p><p>When you train the model you still get a VAE which can produce realistic generations like the ones below, even if we’re using a lossy encoder.</p><figure style=text-align:center><img src=/static/images/vae_post/sparse_recon.png style="width:100%;display:block;margin:0 auto"alt="VAE generations with spike-and-slab prior"><figcaption>Generations for a VAE with spike-and-slab prior; latent_dim = 10, p = 0.8, c² = 0.05</figcaption></figure><p>What’s different about this model and the normal VAE is that when we encode images we only have a few non-zero components in the embedding representation. If the embedding space is $d$-dimensional we expect the model to activate only $p*d$ dimensions after training, which we can see by looking at the image below:</p><figure style=text-align:center><img src=/static/images/vae_post/latent_vis.png style="width:100%;display:block;margin:0 auto"alt="Latent representations for different sample images using a trained model"><figcaption>Each subplot shows the latent representation for a different sample image using the trained model.</figcaption></figure><p>There you go! A sparse variational autoencoder which was obtained just from making a few different choices in the statistical scaffolding of the model. I should also note that spike and slab and normal of course aren’t the only choices when designing your VAEs (personal fave of mine is Gumbel Softmax).</p><h2 id=refresher><a href=#refresher class=anchor></a>Quick refresher on VAE’s</h2><p>In terms of the original VAE proposed (rather offhandedly) by Kingma and Welling in 2014, the story goes something like this: suppose we want to learn the underlying distribution for some data (e.g. images) namely for the purpose of generating samples artificially. Just like in GANs we’d like to be able to convert some samples drawn from a parametric distribution into ones which might have come from our real data generator. This is where the <strong>probibalistic decoder</strong>, $\theta$, comes into play. The goal of $\theta$ is to map low-dimensional noise into hyperparameters of a parametric distribution which generates realistic high-dimensional samples. Think $x|z \sim f(\theta(z))$</p><p>One way to quantify how “good” your decoder is performing is to compute the log probability of a real sample under the decoder framework as</p><p>$$ \log p_{\theta}(x) = \log \int_{\mathcal{Z}}p_{\theta}(x,z)dz $$</p><p>If your decoder is doing its job, then the probability above should be high under your model.</p><p>Since this isn’t a really computationally tractable way to go about things however, another way to express the marginal is through <em>importance sampling</em> w.r.t. the posterior distribution over the latents $z$ given a sample $x$ like</p><div>$$ \log p_{\theta}(x) = \log \int_{\mathcal{Z}}p_{\theta}(x,z) \frac{p_{\theta}(z|x)}{p_{\theta}(z|x)}dz = \log \mathbb{E}_{z\sim p_{\theta}(\cdot | x)}\left[\frac{p_{\theta}(x,z)}{p_{\theta}(z|x)}\right] $$</div><p>where we’ve assumed that initially $ z\sim p(z) $ (<em>this is the part I’m interested in changing!)</em></p><p>Now this is where the authors got a little sneaky, instead of using the true posterior $p_{\theta}(z|x)$ we can instead come up with a proxy for it through the use of an <strong>probibalistic encoder</strong>, $\phi$, which turns an input sample into hyperparameters used to model a parametric distribution over the latent space. Think $z|x \sim g(\phi(x))$. With this we write the above as</p><div>$$ \log p_{\theta}(x) = \log \mathbb{E}_{z\sim q_{\phi}(\cdot | x)}\left[\frac{p_{\theta}(x,z)}{q_{\phi}(z|x)}\right] $$</div><p>Now by Jensen’s inequality (just geometry!) you arrive at a lower bound on the likelihood of a sample under our variational autoencoder given by the <a href=https://en.wikipedia.org/wiki/Evidence_lower_bound>evidence lower bound</a>.</p><div>$$ \begin{align*} \log \mathbb{E}_{z\sim q_{\phi}(\cdot | x)}\left[\frac{p_{\theta}(x,z)}{q_{\phi}(z|x)}\right] &\geq \mathbb{E}_{z\sim q_{\phi}(\cdot | x)}\left[\log \frac{p_{\theta}(x,z)}{q_{\phi}(z|x)}\right]\\ &:= \mathcal{L}(\theta, \phi; x) \end{align*} $$</div><p>Therefore maximimzing $\log p_{\theta}(x)$ becomes equivalent to maximizing the ELBO!</p><p>Fortunately enough there exists a much nicer representation for the ELBO which is a lot more approachable for us in terms of a numerical optimization perspective; starting (magically) from the KL-divergence between the latent posterior provided by the encoder and the associated prior we get</p><div>$$ \begin{align*} & D_{KL}(q_{\phi}(z|x)||p(z)) = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \frac{q_{\phi}(z|x)}{p(z)}\right]\\ &= \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log \frac{q_{\phi}(z|x)}{p_{\theta}(x,z)p_{\theta}(x|z)^{-1}}\right]\\ &= -\mathcal{L}(\theta, \phi;x) + \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] \end{align*} $$</div><p>so that</p><div>$$ \mathcal{L}(\theta, \phi;x) = \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] - D_{KL}(q_{\phi}(z|x)||p(z)) $$</div><p>Hmmm I guess this still looks a bit confusing. To make the case for this model a little bit let's see what happens if we choose to model our probibalistic decoder such that $x|z \sim \mathcal{N}_{n}(\mu_{\theta}(z),1)$.</p>In this case the first term on the right is proportional to<div>$$ \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[\log p_{\theta}(x|z)\right] \propto \mathbb{E}_{z\sim q_{\phi}(\cdot|x)}\left[-\frac{1}{2}(x-\mu_{\theta}(z))^{2}\right] $$</div><p>So that maximizing this term is equivalent to minimizing the reconstruction loss.</p><p>By mixing and matching which probibalisitc frameworks you’re operating with for the encoder prior and posterior, and decoder posterior, the form of the ELBO changes accordingly.</p><h2 id=references><a href=#references class=anchor></a>References</h2><ul><li><a href=https://arxiv.org/abs/2106.09685>Auto-Encoding Variational Bayes</a> by Kingma et al. (2013)</li><li><a href="https://openreview.net/forum?id=Sy2fzU9gl">beta-VAE: Learning Basic Visual Concepts with a Constrained Variational Framework</a> by Higgins et al. (2022)</li></ul><p class=back><a href=#>⮬ Back to top</a></p></main></body></html>